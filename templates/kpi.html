{% extends "base.html" %}

{% block title %}KPI-Bewertung - effic.io{% endblock %}

{% block additional_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='kpi-impact-clean.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='step-navigation.css') }}">
<script src="https://cdn.tailwindcss.com"></script>
<script src="{{ url_for('static', filename='step-navigation.js') }}" defer></script>
{% endblock %}

{% block content %}
            <div class="technik-header">
                <div class="technik-header-content">
                    <div class="technik-header-text">
                        <h2>KPI-Bewertung</h2>
                        <p class="technik-description">Bewerten Sie die strategische Relevanz und KPI-Verbesserungen Ihres KI-Projekts.</p>
                    </div>
                </div>
            </div>
            
            <div class="technik-box">
                <form action="{{ url_for('process_kpi') }}" method="POST" id="kpiForm">
                    <div class="question-container">
                        <!-- Strategische Relevanz -->
                        <div class="question-item question-box">
                            <div class="question-header">
                                <h4>ü•á Frage 1: Welche strategische Relevanz hat das Projekt?</h4>
                            </div>
                            <div class="radio-container">
                                <label class="radio-label">
                                    <input type="radio" name="strategic_relevance" value="operativ" required>
                                    <span>üîò Operativ (taktisch, kurzfristig)</span>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="strategic_relevance" value="wachstum" required>
                                    <span>üöÄ Wachstumstreiber (strategisch)</span>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="strategic_relevance" value="transformativ" required>
                                    <span>üß≠ Zukunftsrelevant / Transformativ (Gamechanger)</span>
                                </label>
                            </div>
                            <div class="tool-tip">
                                <p>üí¨ Tool-Tipp: Projekte mit hoher strategischer Relevanz rechtfertigen meist auch h√∂here Investitionen.</p>
                            </div>
                        </div>
                        
                        
                        <!-- KPI-Impact-Bewertung - Neue saubere Version -->
                        <div class="question-item question-box">
                            <div class="question-header">
                                <h4>ü•à Frage 2: Wie stark verbessert die Idee die Ziel-KPIs?</h4>
                            </div>
                            <div id="kpi-impact-assessment" class="space-y-6">
                                <!-- KPI-Auswahl -->
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <p class="text-sm text-gray-700 mb-4 flex items-center gap-2">
                                        <span>‚ûï</span>
                                        W√§hlen Sie bis zu 3 relevante KPIs, die durch das Projekt beeinflusst werden.
                                    </p>
                                    
                                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3" id="kpi-selection-grid">
                                        <label class="kpi-selection-item" data-kpi="umsatz">
                                            <input type="checkbox" class="kpi-checkbox w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                                            <span class="text-lg">üí∞</span>
                                            <span class="font-medium text-sm">Umsatz</span>
                                        </label>
                                        <label class="kpi-selection-item" data-kpi="kosten">
                                            <input type="checkbox" class="kpi-checkbox w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                                            <span class="text-lg">üìâ</span>
                                            <span class="font-medium text-sm">Kosten</span>
                                        </label>
                                        <label class="kpi-selection-item" data-kpi="durchlaufzeit">
                                            <input type="checkbox" class="kpi-checkbox w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                                            <span class="text-lg">‚ö°</span>
                                            <span class="font-medium text-sm">Durchlaufzeit</span>
                                        </label>
                                        <label class="kpi-selection-item" data-kpi="co2">
                                            <input type="checkbox" class="kpi-checkbox w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                                            <span class="text-lg">üå±</span>
                                            <span class="font-medium text-sm">CO‚ÇÇ-Reduktion</span>
                                        </label>
                                        <label class="kpi-selection-item" data-kpi="kundenbindung">
                                            <input type="checkbox" class="kpi-checkbox w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                                            <span class="text-lg">ü§ù</span>
                                            <span class="font-medium text-sm">Kundenbindung</span>
                                        </label>
                                        <label class="kpi-selection-item" data-kpi="fehlerrate">
                                            <input type="checkbox" class="kpi-checkbox w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                                            <span class="text-lg">üéØ</span>
                                            <span class="font-medium text-sm">Fehlerrate</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- KPI-Impact-Bewertungen -->
                                <div id="kpi-assessments-container" class="space-y-4">
                                    <div id="no-kpi-message" class="text-center py-12 text-gray-500">
                                        <div class="text-4xl mb-4">üìä</div>
                                        <p class="text-lg font-medium">Bitte w√§hlen Sie mindestens eine KPI aus</p>
                                        <p class="text-sm mt-2">W√§hlen Sie bis zu 3 KPIs aus, um deren erwarteten Impact zu bewerten.</p>
                                    </div>
                                </div>

                                <!-- Verstecktes Input f√ºr Form-Submission -->
                                <input type="hidden" name="selected_kpis" id="selectedKpisInput" value="[]">
                            </div>
                        </div>
                        
                        <!-- Hier wurde die Frage zur Investitionsanpassung entfernt -->
                    </div>
                    
                    <div class="navigation-buttons">
                        <a href="{{ url_for('technik_bewertung') }}" class="back-button">‚Üê Zur√ºck zu Technik-Bewertung</a>
                        <button type="submit" class="forward-button" onclick="if(window.stepNavigationManager) window.stepNavigationManager.navigateForward('/user_readiness')">Weiter zur User-Bewertung ‚Üí</button>
                    </div>
                </form>
            </div>

    <script>
        // Saubere KPI-Impact-Bewertung ohne veraltete Komponenten
        document.addEventListener('DOMContentLoaded', function() {
            const maxKPIs = 3;
            let selectedKPIs = [];
            let kpiImpacts = {};
            
            // KPI-Definitionen mit Icons und Benchmarks
            const kpiDefinitions = {
                'umsatz': {
                    name: 'Umsatz',
                    icon: 'üí∞',
                    benchmarks: ['Keine √Ñnderung', '2-5% Steigerung', '5-10% Steigerung', '10-20% Steigerung', '20%+ Steigerung']
                },
                'kosten': {
                    name: 'Kosten',
                    icon: 'üìâ',
                    benchmarks: ['Keine Einsparung', '5-10% Reduktion', '10-20% Reduktion', '20-35% Reduktion', '35%+ Reduktion']
                },
                'durchlaufzeit': {
                    name: 'Durchlaufzeit',
                    icon: '‚ö°',
                    benchmarks: ['Keine Verbesserung', '10-20% schneller', '20-40% schneller', '40-60% schneller', '60%+ schneller']
                },
                'co2': {
                    name: 'CO‚ÇÇ-Reduktion',
                    icon: 'üå±',
                    benchmarks: ['Keine Reduktion', '5-15% weniger CO‚ÇÇ', '15-25% weniger CO‚ÇÇ', '25-40% weniger CO‚ÇÇ', '40%+ weniger CO‚ÇÇ']
                },
                'kundenbindung': {
                    name: 'Kundenbindung',
                    icon: 'ü§ù',
                    benchmarks: ['Keine Verbesserung', '5-10% h√∂here Bindung', '10-20% h√∂here Bindung', '20-30% h√∂here Bindung', '30%+ h√∂here Bindung']
                },
                'fehlerrate': {
                    name: 'Fehlerrate',
                    icon: 'üéØ',
                    benchmarks: ['Keine Reduktion', '10-25% weniger Fehler', '25-50% weniger Fehler', '50-75% weniger Fehler', '75%+ weniger Fehler']
                }
            };
            
            // Impact-Level-Definitionen
            const impactLevels = [
                {
                    level: 1,
                    label: 'Minimal',
                    description: 'Kaum messbare Verbesserung',
                    score: 0.0,
                    colorClass: 'bg-red-500',
                    bgClass: 'bg-red-100',
                    textClass: 'text-red-700'
                },
                {
                    level: 2,
                    label: 'Gering',
                    description: 'Kleine, sp√ºrbare Verbesserung',
                    score: 0.25,
                    colorClass: 'bg-orange-500',
                    bgClass: 'bg-orange-100',
                    textClass: 'text-orange-700'
                },
                {
                    level: 3,
                    label: 'Mittel',
                    description: 'Deutlich messbare Verbesserung',
                    score: 0.5,
                    colorClass: 'bg-yellow-500',
                    bgClass: 'bg-yellow-100',
                    textClass: 'text-yellow-700'
                },
                {
                    level: 4,
                    label: 'Hoch',
                    description: 'Starke, signifikante Verbesserung',
                    score: 0.75,
                    colorClass: 'bg-green-500',
                    bgClass: 'bg-green-100',
                    textClass: 'text-green-700'
                },
                {
                    level: 5,
                    label: 'Extrem',
                    description: 'Transformative Verbesserung',
                    score: 1.0,
                    colorClass: 'bg-emerald-600',
                    bgClass: 'bg-emerald-100',
                    textClass: 'text-emerald-700'
                }
            ];
            
            // CSS-Klassen f√ºr KPI-Auswahl-Items hinzuf√ºgen
            const style = document.createElement('style');
            style.textContent = `
                .kpi-selection-item {
                    display: flex;
                    align-items: center;
                    gap: 0.75rem;
                    padding: 0.75rem;
                    border-radius: 0.5rem;
                    border: 2px solid #e5e7eb;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    background-color: white;
                }
                .kpi-selection-item:hover {
                    border-color: #d1d5db;
                    background-color: #f9fafb;
                }
                .kpi-selection-item.selected {
                    border-color: #3b82f6;
                    background-color: #eff6ff;
                    color: #1e40af;
                }
                .kpi-selection-item.disabled {
                    border-color: #e5e7eb;
                    background-color: #f3f4f6;
                    color: #9ca3af;
                    cursor: not-allowed;
                }
            `;
            document.head.appendChild(style);
            
            // Event-Listener f√ºr KPI-Auswahl
            const kpiSelectionItems = document.querySelectorAll('.kpi-selection-item');
            kpiSelectionItems.forEach(item => {
                const checkbox = item.querySelector('.kpi-checkbox');
                const kpiKey = item.dataset.kpi;
                
                item.addEventListener('click', function(e) {
                    if (e.target === checkbox) return; // Verhindere doppelte Events
                    
                    const isCurrentlySelected = selectedKPIs.includes(kpiKey);
                    const isDisabled = !isCurrentlySelected && selectedKPIs.length >= maxKPIs;
                    
                    if (isDisabled) return;
                    
                    checkbox.checked = !checkbox.checked;
                    handleKPISelection(kpiKey, checkbox.checked);
                });
                
                checkbox.addEventListener('change', function() {
                    handleKPISelection(kpiKey, this.checked);
                });
            });
            
            // KPI-Auswahl behandeln
            function handleKPISelection(kpiKey, isSelected) {
                if (isSelected) {
                    // Pr√ºfe maximale Anzahl
                    if (selectedKPIs.length >= maxKPIs) {
                        // Entferne √§lteste Auswahl
                        const removed = selectedKPIs.shift();
                        delete kpiImpacts[removed];
                        
                        // Deaktiviere Checkbox
                        const removedItem = document.querySelector(`[data-kpi="${removed}"]`);
                        if (removedItem) {
                            removedItem.querySelector('.kpi-checkbox').checked = false;
                            removedItem.classList.remove('selected');
                        }
                        
                        // Entferne Assessment
                        const assessmentToRemove = document.getElementById(`kpi-assessment-${removed}`);
                        if (assessmentToRemove) {
                            assessmentToRemove.remove();
                        }
                    }
                    
                    selectedKPIs.push(kpiKey);
                    
                    // Setze Standard-Impact
                    kpiImpacts[kpiKey] = {
                        level: 3,
                        score: 0.5,
                        label: 'Mittel',
                        description: 'Deutlich messbare Verbesserung'
                    };
                    
                    // Erstelle Assessment
                    createKPIAssessment(kpiKey);
                } else {
                    // Entferne KPI
                    selectedKPIs = selectedKPIs.filter(key => key !== kpiKey);
                    delete kpiImpacts[kpiKey];
                    
                    // Entferne Assessment
                    const assessmentToRemove = document.getElementById(`kpi-assessment-${kpiKey}`);
                    if (assessmentToRemove) {
                        assessmentToRemove.remove();
                    }
                }
                
                updateUIState();
                updateFormData();
            }
            
            // KPI-Assessment erstellen
            function createKPIAssessment(kpiKey) {
                const kpi = kpiDefinitions[kpiKey];
                const container = document.getElementById('kpi-assessments-container');
                
                const assessmentDiv = document.createElement('div');
                assessmentDiv.id = `kpi-assessment-${kpiKey}`;
                assessmentDiv.className = 'bg-white rounded-xl border-2 border-gray-200 p-6 kpi-transition hover:shadow-lg';
                
                assessmentDiv.innerHTML = `
                    <!-- KPI Header -->
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${kpi.icon}</span>
                            <h3 class="text-lg font-semibold text-gray-800">${kpi.name}</h3>
                        </div>
                        <div class="kpi-current-label px-4 py-2 rounded-full font-medium text-sm bg-yellow-500 text-white">
                            Mittel
                        </div>
                    </div>
                    
                    <!-- Impact-Skala -->
                    <div class="space-y-4">
                        <div class="text-center">
                            <h4 class="text-sm font-medium text-gray-600 mb-4 flex items-center justify-center gap-2">
                                <span>üéØ</span>
                                Erwarteter Impact
                            </h4>
                        </div>
                        
                        <!-- Grafische Impact-Punkte -->
                        <div class="relative">
                            <!-- Verbindungslinie -->
                            <div class="absolute top-1/2 left-6 right-6 h-1 impact-connection-line rounded-full transform -translate-y-1/2 z-0"></div>
                            
                            <!-- Impact-Level -->
                            <div class="flex justify-between items-center relative z-10">
                                ${impactLevels.map(impact => `
                                    <button
                                        type="button"
                                        class="impact-level-button group flex flex-col items-center p-2 rounded-lg kpi-transition-fast hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                                        data-kpi="${kpiKey}"
                                        data-level="${impact.level}"
                                        title="${impact.label}: ${impact.description}"
                                    >
                                        <!-- Impact-Punkt -->
                                        <div class="impact-point w-8 h-8 rounded-full border-3 flex items-center justify-center font-bold text-sm kpi-transition ${impact.level === 3 ? impact.colorClass + ' border-transparent text-white shadow-lg' : 'bg-gray-100 border-gray-300 text-gray-600 hover:scale-110'}">
                                            ${impact.level}
                                        </div>
                                        
                                        <!-- Label -->
                                        <span class="impact-label mt-2 text-xs font-medium kpi-transition ${impact.level === 3 ? 'text-gray-800 font-semibold' : 'text-gray-600 group-hover:text-gray-800'}">
                                            ${impact.label}
                                        </span>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Benchmark-Orientierungshilfen -->
                        <div class="mt-6 pt-4 border-t border-gray-100">
                            <div class="benchmark-grid text-xs text-gray-500">
                                ${kpi.benchmarks.map(benchmark => `
                                    <div class="text-center leading-tight">${benchmark}</div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Aktuelle Auswahl Beschreibung -->
                        <div class="impact-description mt-4 p-3 rounded-lg kpi-transition bg-yellow-100">
                            <p class="text-sm font-medium text-yellow-700">
                                Deutlich messbare Verbesserung
                            </p>
                        </div>
                    </div>
                `;
                
                container.appendChild(assessmentDiv);
                
                // Event-Listener f√ºr Impact-Level
                const impactButtons = assessmentDiv.querySelectorAll('.impact-level-button');
                impactButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const level = parseInt(this.dataset.level);
                        selectImpactLevel(kpiKey, level);
                    });
                });
            }
            
            // Impact-Level ausw√§hlen
            function selectImpactLevel(kpiKey, level) {
                const impact = impactLevels.find(i => i.level === level);
                if (!impact) return;
                
                // Aktualisiere Daten
                kpiImpacts[kpiKey] = {
                    level,
                    score: impact.score,
                    label: impact.label,
                    description: impact.description
                };
                
                const assessment = document.getElementById(`kpi-assessment-${kpiKey}`);
                if (!assessment) return;
                
                // Aktualisiere UI
                const buttons = assessment.querySelectorAll('.impact-level-button');
                buttons.forEach(button => {
                    const buttonLevel = parseInt(button.dataset.level);
                    const point = button.querySelector('.impact-point');
                    const label = button.querySelector('.impact-label');
                    const buttonImpact = impactLevels.find(i => i.level === buttonLevel);
                    
                    if (buttonLevel === level) {
                        // Aktiv
                        button.classList.add('impact-level-active');
                        point.className = `impact-point w-8 h-8 rounded-full border-3 flex items-center justify-center font-bold text-sm kpi-transition ${buttonImpact.colorClass} border-transparent text-white shadow-lg`;
                        label.className = 'impact-label mt-2 text-xs font-medium kpi-transition text-gray-800 font-semibold';
                    } else {
                        // Inaktiv
                        button.classList.remove('impact-level-active');
                        point.className = 'impact-point w-8 h-8 rounded-full border-3 flex items-center justify-center font-bold text-sm kpi-transition bg-gray-100 border-gray-300 text-gray-600 hover:scale-110';
                        label.className = 'impact-label mt-2 text-xs font-medium kpi-transition text-gray-600 group-hover:text-gray-800';
                    }
                });
                
                // Aktualisiere Header-Label
                const headerLabel = assessment.querySelector('.kpi-current-label');
                if (headerLabel) {
                    headerLabel.className = `kpi-current-label px-4 py-2 rounded-full font-medium text-sm kpi-transition ${impact.colorClass} text-white`;
                    headerLabel.textContent = impact.label;
                }
                
                // Aktualisiere Beschreibung
                const description = assessment.querySelector('.impact-description');
                if (description) {
                    description.className = `impact-description mt-4 p-3 rounded-lg kpi-transition ${impact.bgClass}`;
                    description.querySelector('p').className = `text-sm font-medium ${impact.textClass}`;
                    description.querySelector('p').textContent = impact.description;
                }
                
                updateFormData();
            }
            
            // UI-Status aktualisieren
            function updateUIState() {
                // KPI-Auswahl-Items aktualisieren
                kpiSelectionItems.forEach(item => {
                    const kpiKey = item.dataset.kpi;
                    const isSelected = selectedKPIs.includes(kpiKey);
                    const isDisabled = !isSelected && selectedKPIs.length >= maxKPIs;
                    
                    item.classList.toggle('selected', isSelected);
                    item.classList.toggle('disabled', isDisabled);
                });
                
                // No-KPI-Message anzeigen/verstecken
                const noKPIMessage = document.getElementById('no-kpi-message');
                if (noKPIMessage) {
                    noKPIMessage.style.display = selectedKPIs.length === 0 ? 'block' : 'none';
                }
            }
            
            // Form-Daten aktualisieren
            function updateFormData() {
                const selectedKpisInput = document.getElementById('selectedKpisInput');
                if (selectedKpisInput) {
                    const kpiData = selectedKPIs.map(kpiKey => ({
                        value: kpiKey,
                        name: kpiDefinitions[kpiKey].name,
                        ...kpiImpacts[kpiKey]
                    }));
                    selectedKpisInput.value = JSON.stringify(kpiData);
                }
            }
            
            // Initialisierung
            updateUIState();
            updateFormData();
        });
    </script>
{% endblock %}